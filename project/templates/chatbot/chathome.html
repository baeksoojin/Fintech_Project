{% load static %}
<!doctype html>
    <html lang="en">
        <head>
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <meta name="viewport"
                content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
            <meta name="apple-mobile-web-app-capable" content="yes" />
            <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
            <meta name="theme-color" content="#000000">
            <title>시니어를 위한 가족결합 금융플랫폼</title>
            <meta name="description" content="Mobilekit HTML Mobile UI Kit">
            <meta name="keywords" content="bootstrap 5, mobile template, cordova, phonegap, mobile, html" />
            <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}" sizes="32x32">
            <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/icon/192x192.png' %}">
            <link rel="stylesheet" href="{% static 'css/style.css' %}">
        </head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <title>챗봇</title>
        {% block scripts %}
        <script> 

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                let i=0;
                for (i; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');
        var xhr;
        
        function chatTrain(){
            alert('chatTrain...');
        }
        function sendAsk(){
            text = document.getElementById('chattext').value;
            if(text == ""){
                document.getElementById('chattext').focus();
                return false;
            }
            console.log('text');
            addtext = '<div class="message-item user"><div class="content"><div class="bubble" style="font-size:20px; font-weight : bold;">' + text + '</div></div><div>';
            document.getElementById('appCapsule').innerHTML += addtext;

            const strurl = "chatbot?text="+text;
            console.log(strurl);

            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4){
                    var data = xhr.responseText;
                    var obj =JSON.parse(data);
                    console.log(typeof(obj));
                    console.log(obj.text);
                    const text_data = JSON.parse(obj.text);
                    answer = text_data['bubbles'][0].data['description']
                    if(!answer){
                        answer = text_data['bubbles'][0].data['cover']['data'].description}
                    console.log(answer);
                    if(obj.flag == "0"){


                        bottext = "<div class='message-item'><img src='"+'{% static "img/chatbot.png" %}'+"'alt='avatar' class='avatar'><div class='content'><div class='title' style='font-size:15px;'>챗봇</div><div class='bubble' style='font-size:20px; font-weight : bold;'>" + answer + "</div></div></div>";
                                
                        document.getElementById("appCapsule").innerHTML += bottext;

                        var objDiv = document.getElementById("appCapsule");

                        objDiv.scrollTop = objDiv.scrollHeight;

                        document.getElementById("chattext").value = "";
                        document.getElementById("chattext").focus();

                    }
                }
            };
            xhr.open("GET",strurl);
            xhr.setRequestHeader("X-CSRFToken",csrftoken);
            xhr.send(null);
        }
    </script>
    {% endblock %}
    {% block styles %}
    <style>
        .chatheader{
            position:fixed;
            left:0;
            top:0;
            width: 100%;
            padding:18px 0;
            background-color: #DDD;
            color:#000;
            text-align: center;
        }
        .chatfooter{
            position:fixed;
            left:0;
            bottom:0;
            width: 100%;
            padding:18px 0;
            background-color: #FFF;
            color:#000;
            text-align: center;
        }

    </style>
    {% endblock %}
        
</head>

<body>

    <div>
        <!-- loader -->
        <div id="loader">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
        <!-- * loader -->
        <!-- App Header -->
        <div class="appHeader bg-primary text-light">
            <div class="left">
                <a href="{% url 'main:home' %}" class="headerButton">
                    <ion-icon name="chevron-back-outline"></ion-icon>
                </a>
            </div>
            <div class="pageTitle" style='font-size:20px; font-weight : bold;'> 챗봇 </div>
        </div>
        <!-- * App Header -->
        <div id="appCapsule" >
            <div class="message-divider">
                <br/>
            </div>

            <div class="message-item">
                <img src='{% static "img/chatbot.png" %}' alt='avatar' class='avatar'>
                <div class="content">
                    <div class="title" style='font-size:15px;'>챗봇</div>
                    <div class="bubble" style='font-size:20px; font-weight : bold;'>
                        안녕하세요 ~ 원하시는 것을 물어봐주세요
                    </div>
                </div>
            </div>
        </div>
        <!-- chat footer -->
        <div class="chatFooter">
            <form>
                <div class="form-group boxed">
                    <div class="input-wrapper">
                        <input type="text" class="form-control" placeholder="Type a message..."  id="chattext">
                        <i class="clear-input">
                            <ion-icon name="close-circle"></ion-icon>
                        </i>
                    </div>
                </div>
                <button type="button" class="btn btn-icon btn-primary rounded" onclick="sendAsk()">
                    <ion-icon name="send"></ion-icon> 
                </button>
            </form>
        </div>

    <!-- * welcome notification -->

        <!-- ============== Js Files ==============  -->
        <!-- Bootstrap -->
        <script src="{% static 'js/lib/bootstrap.min.js' %}"></script>
        <!-- Ionicons -->
        <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
        <!-- Splide -->
        <script src="{% static 'js/plugins/splide/splide.min.js' %}"></script>
        <!-- ProgressBar js -->
        <script src="{% static 'js/plugins/progressbar-js/progressbar.min.js' %}"></script>
        <!-- Base Js File -->
        <script src="{% static 'js/base.js' %}"></script>

    </body>

</html>


